---
interface Props {
  lessons: Array<{
    id: string;
    data: {
      title: string;
      module: number;
      lesson: number;
      moduleTitle: string;
    };
  }>;
  currentId: string;
}

const { lessons, currentId } = Astro.props;

// Group lessons by module
const modules = new Map<number, { title: string; lessons: typeof lessons }>();
for (const lesson of lessons) {
  const mod = lesson.data.module;
  if (!modules.has(mod)) {
    modules.set(mod, { title: lesson.data.moduleTitle, lessons: [] });
  }
  modules.get(mod)!.lessons.push(lesson);
}
---

<div class="mb-6">
  <h4 class="text-xs font-semibold text-slate-500 dark:text-slate-500 uppercase tracking-wider mb-3">
    Course Content
  </h4>
  <nav aria-label="Course lessons">
    {Array.from(modules.entries()).map(([moduleNum, moduleData]) => (
      <div class="mb-4">
        <p class="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-2">
          Module {moduleNum}: {moduleData.title}
        </p>
        <ul class="space-y-0.5">
          {moduleData.lessons.map((lesson) => {
            const isCurrent = lesson.id === currentId;
            return (
              <li>
                <a
                  href={`/learn/${lesson.id}`}
                  class:list={[
                    'block text-sm py-1.5 px-3 rounded-lg transition-colors',
                    isCurrent
                      ? 'bg-purple-50 dark:bg-purple-900/20 text-purple-700 dark:text-purple-400 font-medium border-l-2 border-purple-600 dark:border-purple-400'
                      : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:bg-slate-50 dark:hover:bg-slate-800/50',
                  ]}
                  aria-current={isCurrent ? 'page' : undefined}
                >
                  <span class="text-xs text-slate-400 dark:text-slate-600 mr-1.5">{lesson.data.lesson}.</span>
                  {lesson.data.title}
                </a>
              </li>
            );
          })}
        </ul>
      </div>
    ))}
  </nav>
</div>

<script>
  function scrollToCurrentLesson() {
    const current = document.querySelector('[aria-current="page"]');
    if (!current) return;
    const scrollContainer = current.closest('.sidebar-scroll');
    if (!scrollContainer) return;
    const containerRect = scrollContainer.getBoundingClientRect();
    const currentRect = current.getBoundingClientRect();
    const offset = currentRect.top - containerRect.top - containerRect.height / 3;
    scrollContainer.scrollTop += offset;
  }

  scrollToCurrentLesson();
  document.addEventListener('astro:page-load', scrollToCurrentLesson);
</script>
