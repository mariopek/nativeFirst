---
export const prerender = true;

import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../../../lib/utils';
import { BLOG_TAGS, SITE, BLOG_ENGAGEMENT } from '../../../lib/constants';
import readingTime from 'reading-time';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BaseLayout title={`Blog â€” ${SITE.name} (Comeau Style)`}>
  <style>
    :root {
      --jc-bg-light: #f9f5f0;
      --jc-bg-warm: #fff8f0;
      --jc-surface: #ffffff;
      --jc-text: #1b2d45;
      --jc-text-muted: #617d98;
      --jc-border: #e4ddd4;
      --jc-pink: #ff6b9d;
      --jc-orange: #ff8a5c;
      --jc-yellow: #ffc764;
      --jc-green: #25c685;
      --jc-blue: #4c9aff;
      --jc-purple: #b37aff;
      --jc-indigo: #6c63ff;
      --jc-rainbow: linear-gradient(135deg, #ff6b9d, #ff8a5c, #ffc764, #25c685, #4c9aff, #b37aff);
      --jc-shadow-color: 220deg 30% 50%;
      --jc-radius: 16px;
    }

    .jc-body {
      background: var(--jc-bg-light) !important;
      color: var(--jc-text);
    }

    .jc-rainbow-bar {
      height: 4px;
      background: var(--jc-rainbow);
    }

    @keyframes jc-rainbow-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .jc-rainbow-animated {
      background: linear-gradient(135deg, #ff6b9d, #ff8a5c, #ffc764, #25c685, #4c9aff, #b37aff, #ff6b9d);
      background-size: 300% 300%;
      animation: jc-rainbow-shift 8s ease infinite;
    }

    .jc-card {
      background: var(--jc-surface);
      border-radius: var(--jc-radius);
      border: 1px solid var(--jc-border);
      box-shadow:
        0 1px 2px hsl(var(--jc-shadow-color) / 0.05),
        0 4px 8px hsl(var(--jc-shadow-color) / 0.04),
        0 12px 24px hsl(var(--jc-shadow-color) / 0.03);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .jc-card:hover {
      transform: translateY(-4px) rotate(-0.5deg);
      box-shadow:
        0 2px 4px hsl(var(--jc-shadow-color) / 0.06),
        0 8px 16px hsl(var(--jc-shadow-color) / 0.06),
        0 24px 48px hsl(var(--jc-shadow-color) / 0.05);
    }

    .jc-gradient-text {
      background: var(--jc-rainbow);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .jc-tag {
      font-size: 12px;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 99px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .jc-tag-pink { background: #fff0f5; color: var(--jc-pink); }
    .jc-tag-blue { background: #eef5ff; color: var(--jc-blue); }
    .jc-tag-green { background: #eafff5; color: var(--jc-green); }
    .jc-tag-orange { background: #fff5ee; color: var(--jc-orange); }
    .jc-tag-purple { background: #f5f0ff; color: var(--jc-purple); }

    .jc-tag-filter {
      font-size: 14px;
      font-weight: 600;
      padding: 8px 20px;
      border-radius: 99px;
      border: 2px solid var(--jc-border);
      background: var(--jc-surface);
      color: var(--jc-text-muted);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      white-space: nowrap;
      cursor: pointer;
    }

    .jc-tag-filter:hover {
      border-color: var(--jc-indigo);
      color: var(--jc-indigo);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px hsl(var(--jc-shadow-color) / 0.1);
    }

    .jc-tag-filter.active {
      background: var(--jc-indigo);
      border-color: var(--jc-indigo);
      color: white;
      box-shadow: 0 2px 12px hsl(250deg 50% 40% / 0.25);
    }

    .jc-hero-bg {
      background:
        radial-gradient(ellipse 70% 50% at 50% 0%, rgba(179, 122, 255, 0.08), transparent),
        radial-gradient(ellipse 50% 40% at 80% 80%, rgba(255, 107, 157, 0.06), transparent),
        var(--jc-bg-warm);
    }

    .jc-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: white;
      font-size: 11px;
    }

    .jc-engagement-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 10px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 600;
      background: #f9f5f0;
      color: var(--jc-text-muted);
    }
  </style>

  <div class="jc-body min-h-screen">
    <!-- Rainbow top bar -->
    <div class="jc-rainbow-bar jc-rainbow-animated"></div>

    <!-- Nav -->
    <nav class="sticky top-0 z-50 border-b border-[#e4ddd4]" style="background: rgba(249, 245, 240, 0.9); backdrop-filter: blur(12px);">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 flex items-center justify-between h-16">
        <a href="/experiment/comeau/" class="flex items-center gap-3 group">
          <div class="w-10 h-10 rounded-2xl jc-rainbow-animated flex items-center justify-center shadow-md group-hover:scale-110 transition-transform duration-300">
            <span class="text-white font-black text-sm">NF</span>
          </div>
          <span class="font-display font-bold text-lg text-[#1b2d45]">
            NativeFirst
          </span>
        </a>
        <div class="hidden md:flex items-center gap-1">
          <a href="/experiment/comeau/" class="px-4 py-2 text-sm font-medium text-[#617d98] rounded-lg hover:bg-white/60 hover:text-[#1b2d45] transition-colors">Home</a>
          <a href="#" class="px-4 py-2 text-sm font-medium text-[#617d98] rounded-lg hover:bg-white/60 hover:text-[#1b2d45] transition-colors">Apps</a>
          <a href="/experiment/comeau/blog" class="px-4 py-2 text-sm font-semibold text-[#1b2d45] rounded-lg hover:bg-white/60 transition-colors">Blog</a>
          <a href="/learn" class="px-4 py-2 text-sm font-medium text-[#617d98] rounded-lg hover:bg-white/60 hover:text-[#1b2d45] transition-colors">Learn</a>
        </div>
        <a href="/" class="text-xs text-[#a0a0a0] hover:text-[#617d98] transition-colors">back to main</a>
      </div>
    </nav>

    <!-- Hero -->
    <section class="jc-hero-bg">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 py-16 sm:py-20 text-center">
        <span class="jc-tag jc-tag-purple mb-6 inline-block">Our Blog</span>
        <h1 class="font-display font-extrabold text-4xl sm:text-5xl md:text-6xl text-[#1b2d45] mb-4 leading-[1.15]">
          Thoughts & <span class="jc-gradient-text">discoveries</span>
        </h1>
        <p class="text-lg text-[#617d98] max-w-lg mx-auto">
          Deep dives on native app development, SwiftUI, AI, and the craft of building delightful software.
        </p>
      </div>
    </section>

    <!-- Tag Filters -->
    <section class="sticky top-16 z-30 border-b border-[#e4ddd4] py-3" style="background: rgba(249, 245, 240, 0.92); backdrop-filter: blur(12px);">
      <div class="max-w-5xl mx-auto px-4 sm:px-6">
        <div class="flex items-center gap-2 overflow-x-auto" style="scrollbar-width: none; -ms-overflow-style: none;">
          {BLOG_TAGS.map((tag, i) => (
            <a
              href={tag === 'All' ? '/experiment/comeau/blog' : `/blog/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}
              class:list={['jc-tag-filter', i === 0 && 'active']}
            >
              {tag}
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- Posts Grid -->
    <section class="py-12 sm:py-16" style="background: var(--jc-bg-light);">
      <div class="max-w-5xl mx-auto px-4 sm:px-6">
        {posts.length === 0 ? (
          <div class="text-center py-20">
            <p class="text-[#617d98] text-lg">No posts yet. Check back soon!</p>
          </div>
        ) : (
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {posts.map((post, i) => {
              const rt = readingTime(post.body || '');
              const engagement = BLOG_ENGAGEMENT[post.id] || { likes: 0, comments: [] };
              const tagColors = ['jc-tag-pink', 'jc-tag-blue', 'jc-tag-green', 'jc-tag-orange', 'jc-tag-purple'];
              const bgColors = ['#fff0f5', '#eef5ff', '#f5f0ff', '#fff5ee', '#eafff5'];
              const avatarColors = ['#ff6b9d', '#4c9aff', '#b37aff', '#ff8a5c', '#25c685'];

              return (
                <a href={`/blog/${post.id}`} class="jc-card overflow-hidden group block">
                  <!-- Cover -->
                  <div class="aspect-video relative overflow-hidden" style={`background: ${bgColors[i % bgColors.length]};`}>
                    {post.data.coverImage ? (
                      <img
                        src={post.data.coverImage}
                        alt={post.data.coverImageAlt || post.data.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                      />
                    ) : (
                      <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-4xl opacity-20">&#128221;</span>
                      </div>
                    )}
                    {/* Reading time bubble */}
                    <div class="absolute top-3 right-3">
                      <span class="text-xs font-bold px-3 py-1 rounded-full bg-white/90 text-[#617d98] shadow-sm backdrop-blur-sm">{rt.text}</span>
                    </div>
                  </div>

                  <!-- Content -->
                  <div class="p-5">
                    <div class="flex items-center gap-2 mb-3 flex-wrap">
                      {post.data.tags.slice(0, 2).map((tag, ti) => (
                        <span class:list={['jc-tag', tagColors[(i + ti) % tagColors.length]]}>
                          {tag}
                        </span>
                      ))}
                    </div>

                    <h2 class="font-display font-bold text-base text-[#1b2d45] mb-2 group-hover:text-[#6c63ff] transition-colors line-clamp-2">
                      {post.data.title}
                    </h2>

                    <p class="text-sm text-[#617d98] line-clamp-2 mb-4">
                      {post.data.description}
                    </p>

                    <!-- Author row -->
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <div class="jc-avatar" style={`background: ${avatarColors[i % avatarColors.length]};`}>
                          {post.data.author.charAt(0)}
                        </div>
                        <div>
                          <span class="text-xs font-semibold text-[#1b2d45] block">{post.data.author}</span>
                          <time class="text-[10px] text-[#a0a0a0]">{formatDate(post.data.pubDate)}</time>
                        </div>
                      </div>

                      {/* Engagement */}
                      {(engagement.likes > 0 || engagement.comments.length > 0) && (
                        <div class="flex items-center gap-2">
                          {engagement.likes > 0 && (
                            <span class="jc-engagement-pill">
                              <svg class="w-3.5 h-3.5 text-[#ff6b9d]" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
                              </svg>
                              {engagement.likes}
                            </span>
                          )}
                          {engagement.comments.length > 0 && (
                            <span class="jc-engagement-pill">
                              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                              </svg>
                              {engagement.comments.length}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        )}
      </div>
    </section>

    <!-- Footer -->
    <footer class="border-t border-[#e4ddd4] py-8" style="background: var(--jc-bg-light);">
      <div class="max-w-5xl mx-auto px-4 sm:px-6">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-xl jc-rainbow-animated flex items-center justify-center">
              <span class="text-white font-black text-xs">NF</span>
            </div>
            <span class="text-sm text-[#617d98]">&copy; {new Date().getFullYear()} NativeFirst. Made with care.</span>
          </div>
          <div class="flex items-center gap-6">
            <a href="/experiment/comeau/" class="text-xs text-[#a0a0a0] hover:text-[#6c63ff] transition-colors font-medium">Home</a>
            <a href="/experiment/comeau/blog" class="text-xs text-[#a0a0a0] hover:text-[#6c63ff] transition-colors font-medium">Blog</a>
            <a href="/privacy" class="text-xs text-[#a0a0a0] hover:text-[#6c63ff] transition-colors font-medium">Privacy</a>
          </div>
        </div>
      </div>
      <div class="jc-rainbow-bar jc-rainbow-animated mt-8"></div>
    </footer>
  </div>
</BaseLayout>
