---
export const prerender = false;

import CourseLayout from '../../layouts/CourseLayout.astro';
import { getCollection, render, getEntry } from 'astro:content';
import { getCourseBySlug } from '../../lib/constants';

const { slug } = Astro.params;

// Fetch the lesson by slug
const lesson = await getEntry('course', slug!);

if (!lesson || lesson.data.draft) {
  return Astro.redirect('/404');
}

// Premium course lessons are not yet available
if (lesson.data.courseSlug === 'ship-native') {
  return Astro.redirect('/learn/ship-native');
}

const { Content, headings } = await render(lesson);

const courseSlug = lesson.data.courseSlug;
const courseData = getCourseBySlug(courseSlug);

// Filter lessons to only this course
const allLessons = await getCollection('course', ({ data }) => !data.draft);
const courseLessons = allLessons
  .filter((l) => l.data.courseSlug === courseSlug)
  .sort(
    (a, b) => (a.data.module * 100 + a.data.lesson) - (b.data.module * 100 + b.data.lesson)
  );

const currentIndex = courseLessons.findIndex((l) => l.id === lesson.id);
const prevLesson = currentIndex > 0 ? courseLessons[currentIndex - 1] : null;
const nextLesson = currentIndex < courseLessons.length - 1 ? courseLessons[currentIndex + 1] : null;
---

<CourseLayout
  lesson={lesson}
  headings={headings}
  allLessons={courseLessons}
  prevLesson={prevLesson}
  nextLesson={nextLesson}
  currentIndex={currentIndex}
  courseData={courseData}
>
  <Content />
</CourseLayout>
