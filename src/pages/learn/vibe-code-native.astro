---
export const prerender = true;

import PageLayout from '../../layouts/PageLayout.astro';
import { getCollection } from 'astro:content';
import { SITE, COURSE } from '../../lib/constants';
import CourseCard from '../../components/course/CourseCard.astro';
import PremiumCTA from '../../components/course/PremiumCTA.astro';
import BlogComments from '../../components/blog/BlogComments';

const allLessons = await getCollection('course', ({ data }) => !data.draft && data.courseSlug === 'vibe-code-native');
const lessons = allLessons.sort(
  (a, b) => (a.data.module * 100 + a.data.lesson) - (b.data.module * 100 + b.data.lesson)
);

const moduleLessons = COURSE.modules.map((mod) =>
  lessons.filter((l) => l.data.module === mod.number)
);

const courseSchema = {
  '@context': 'https://schema.org',
  '@type': 'Course',
  name: `${COURSE.title} — ${COURSE.subtitle}`,
  description: COURSE.description,
  provider: {
    '@type': 'Organization',
    name: 'NativeFirst',
    sameAs: SITE.url,
  },
  isAccessibleForFree: true,
  hasCourseInstance: {
    '@type': 'CourseInstance',
    courseMode: 'online',
    courseWorkload: 'PT2H',
  },
  educationalLevel: 'Beginner',
  teaches: 'AI-assisted iOS development with Claude Code and SwiftUI',
  inLanguage: 'en',
};

const firstLesson = lessons[0];
---

<PageLayout
  title={`${COURSE.title} — Free iOS Development Course — ${SITE.name}`}
  description={COURSE.description}
>
  <script type="application/ld+json" set:html={JSON.stringify(courseSchema)} />

  <!-- Breadcrumb -->
  <section class="bg-bg pt-6">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex items-center gap-2 text-sm text-text-muted">
        <a href="/learn" class="hover:text-accent transition-colors">Courses</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-white font-medium">{COURSE.title}</span>
      </nav>
    </div>
  </section>

  <!-- Hero -->
  <section class="relative py-20 sm:py-28 overflow-hidden bg-bg">
    <div class="absolute inset-0 hero-gradient opacity-50"></div>
    <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-accent/10 text-accent text-sm font-medium mb-6">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        Free Course
      </div>

      <h1 class="font-display font-extrabold text-4xl sm:text-5xl md:text-6xl text-white mb-6 leading-tight">
        <span class="gradient-text">{COURSE.title}</span>
        <br />
        <span class="text-3xl sm:text-4xl md:text-5xl">{COURSE.subtitle}</span>
      </h1>

      <p class="text-lg sm:text-xl text-text-muted mb-8 max-w-2xl mx-auto">
        {COURSE.description}
      </p>

      {firstLesson && (
        <a
          href={`/learn/${firstLesson.id}`}
          class="inline-flex items-center gap-2 px-8 py-4 rounded-full gradient-brand text-white font-semibold text-lg shadow-lg shadow-accent/25 hover:shadow-accent/40 transition-shadow"
        >
          Start Learning
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
          </svg>
        </a>
      )}
    </div>
  </section>

  <!-- Stats -->
  <section class="py-8 border-t border-b border-border bg-surface">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-6 text-center">
        <div>
          <p class="font-display font-bold text-2xl text-white">{COURSE.totalLessons}</p>
          <p class="text-sm text-text-muted">Lessons</p>
        </div>
        <div>
          <p class="font-display font-bold text-2xl text-white">{COURSE.modules.length}</p>
          <p class="text-sm text-text-muted">Modules</p>
        </div>
        <div>
          <p class="font-display font-bold text-2xl gradient-text">FREE</p>
          <p class="text-sm text-text-muted">No paywalls</p>
        </div>
        <div>
          <p class="font-display font-bold text-2xl text-white">~2h</p>
          <p class="text-sm text-text-muted">Reading time</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Modules -->
  <section class="py-16 sm:py-20 bg-bg">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="font-display font-bold text-2xl sm:text-3xl text-white mb-10 text-center">
        Course Content
      </h2>

      <div class="space-y-8">
        {COURSE.modules.map((mod, i) =>
          moduleLessons[i].length > 0 ? (
            <CourseCard
              moduleNumber={mod.number}
              moduleTitle={mod.title}
              moduleDescription={mod.description}
              lessons={moduleLessons[i]}
            />
          ) : null
        )}
      </div>

      {moduleLessons.some((ml, i) => ml.length === 0 && i < COURSE.modules.length) && (
        <div class="mt-8 p-6 rounded-2xl border border-dashed border-border text-center">
          <p class="text-text-muted mb-1">More modules coming soon</p>
          <p class="text-sm text-text-muted">
            Build projects, architecture deep-dives, Invoize case study, and advanced topics
          </p>
        </div>
      )}
    </div>
  </section>

  <!-- Premium CTA -->
  <PremiumCTA variant="hero" />

  <!-- Comments -->
  <section class="py-16 sm:py-20 bg-bg">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <div id="comments">
        <BlogComments slug="learn-course" client:visible />
      </div>
    </div>
  </section>
</PageLayout>
